<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Pharmida</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main style="max-width:1100px;margin:24px auto;">
    <h2>Admin Panel</h2>

        <div id="adminUI" style="display:none;margin-top:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>Signed in as <strong>admin</strong></div>
        <div>
          <button onclick="window.location='/admin-dashboard.html'" style="padding:8px 16px;background:#667eea;border:none;border-radius:6px;color:#fff;cursor:pointer;margin-right:8px;">Dashboard</button>
          <button id="logoutBtn" style="padding:8px 12px;background:#ff6b6b;border:none;border-radius:6px;color:#fff;cursor:pointer">Logout</button>
        </div>
      </div>
      <h3>Products</h3>
      <div id="productList"></div>
      <h3 style="margin-top:22px">Add New Product</h3>
      <form id="adminUpload" enctype="multipart/form-data">
        <input name="productName" placeholder="Name" required style="width:60%"><br><br>
        <input name="price" placeholder="Price" required type="number"><br><br>
        <input name="productImage" type="file" accept="image/*" required><br><br>
        <textarea name="description" placeholder="Description"></textarea><br><br>
        <input name="discount" placeholder="Discount (eg 10% Off)"><br><br>
        <button type="submit">Add Product</button>
        <span id="adminStatus" style="margin-left:12px;font-weight:600;color:#206030"></span>
      </form>
    </div>
  </main>

  <script>
    // On load: check server-side session. If not authenticated, redirect to login page.
    (async function(){
      try {
        const res = await fetch('/api/session', { credentials: 'same-origin' });
        if (!res.ok) { window.location.href = '/admin-login.html'; return; }
        const json = await res.json();
        if (json && json.ok) { document.getElementById('adminUI').style.display='block'; loadProducts(); }
        else { window.location.href = '/admin-login.html'; }
      } catch (err) { window.location.href = '/admin-login.html'; }
    })();

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
      window.location.href = '/admin-login.html';
    });
    async function loadProducts() {
      const res = await fetch('/api/products');
      const data = await res.json();
      const list = document.getElementById('productList');
      list.innerHTML = '';
      data.products.forEach(p => {
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center'; row.style.padding='8px 0';
        row.innerHTML = `<img src="${p.imageUrl}" style="width:80px;height:60px;object-fit:cover;border-radius:6px;"/><div style="flex:1;"><strong>${p.name}</strong><div>â‚¹${p.price}</div><div>${p.description||''}</div></div><div><button data-id="${p.id}" class="editBtn">Edit</button> <button data-id="${p.id}" class="delBtn">Delete</button></div>`;
        list.appendChild(row);
      });
      document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', async (e) => {
        if (!confirm('Delete product?')) return;
        const id = e.target.dataset.id;
        await fetch('/api/products/'+id, { method: 'DELETE', credentials: 'same-origin' });
        loadProducts();
      }));
      document.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', (e) => {
        const id = e.target.dataset.id; window.location = '/admin-edit.html?id='+id;
      }));
    }

    document.getElementById('adminUpload').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      document.getElementById('adminStatus').textContent = 'Uploading...';
  const res = await fetch('/api/products', { method: 'POST', body: fd, credentials: 'same-origin' });
      const data = await res.json();
      if (res.ok) { document.getElementById('adminStatus').textContent = 'Added'; loadProducts(); e.target.reset(); setTimeout(()=>document.getElementById('adminStatus').textContent='',1200);} else { document.getElementById('adminStatus').textContent = data.error || 'Error'; }
    });
  </script>
</body>
</html>