<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - Pharmida</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .dashboard-container { max-width: 1400px; margin: 24px auto; padding: 20px; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .tabs { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .tab { padding: 12px 24px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .tab.active { background: #4fd17c; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .data-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .data-table th { background: #f8f8f8; font-weight: 600; }
    .data-table tr:hover { background: #f9f9f9; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; }
    .status-pending { background: #fff4e6; color: #ff8800; }
    .status-completed { background: #e6ffe6; color: #00aa00; }
    .status-scanned { background: #e6f2ff; color: #0066cc; }
    .action-btn { padding: 6px 12px; margin: 0 4px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
    .btn-complete { background: #4fd17c; color: #fff; }
    .btn-view { background: #2196f3; color: #fff; }
    .btn-delete { background: #ff5c5c; color: #fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .stat-card h3 { margin: 0 0 8px 0; font-size: 2em; }
    .stat-card p { margin: 0; opacity: 0.9; }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div>
        <h1>Admin Dashboard</h1>
        <p>Manage all your data from one place</p>
      </div>
      <div>
        <button onclick="window.location='/admin.html'" style="padding:10px 20px;background:#4fd17c;border:none;border-radius:8px;color:#fff;margin-right:10px;">Product Manager</button>
        <button id="logoutBtn" style="padding:10px 20px;background:#ff6b6b;border:none;border-radius:8px;color:#fff;">Logout</button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card green">
        <h3 id="totalOrders">0</h3>
        <p>Total Orders</p>
      </div>
      <div class="stat-card orange">
        <h3 id="totalPrescriptions">0</h3>
        <p>Prescriptions</p>
      </div>
      <div class="stat-card blue">
        <h3 id="totalAmbulance">0</h3>
        <p>Ambulance Requests</p>
      </div>
      <div class="stat-card purple">
        <h3 id="totalDoctor">0</h3>
        <p>Doctor Appointments</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab(event,'orders')">Orders</button>
      <button class="tab" onclick="showTab(event,'profiles')">User Profiles</button>
  <button class="tab" onclick="showTab(event,'prescriptions')">Prescriptions</button>
  <button class="tab" onclick="showTab(event,'scan')">Scan Prescription</button>
      <button class="tab" onclick="showTab(event,'ambulance')">Ambulance Requests</button>
      <button class="tab" onclick="showTab(event,'doctor')">Doctor Appointments</button>
      <button class="tab" onclick="showTab(event,'products')">Products</button>
      <button class="tab" onclick="showTab(event,'payments')">Payments</button>
    </div>

    <!-- Orders Tab -->
    <div id="orders" class="tab-content active">
      <h2>All Orders</h2>
      <table class="data-table" id="ordersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cart ID</th>
            <th>Total (₹)</th>
            <th>Items</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Profiles Tab -->
    <div id="profiles" class="tab-content">
      <h2>User Profiles</h2>
      <table class="data-table" id="profilesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Prescriptions Tab -->
    <div id="prescriptions" class="tab-content">
      <h2>Prescription Uploads</h2>
      <div style="margin-bottom:12px;">
        <form id="prescriptionUploadForm" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input type="file" name="prescriptionFile" accept="image/*,application/pdf" capture="environment" required />
          <input type="text" name="prescriptionNotes" placeholder="Notes (optional)" style="padding:8px;border-radius:6px;border:1px solid #ddd;min-width:220px;" />
          <button type="submit" id="uploadPrescriptionBtn" style="padding:8px 12px;background:#2196f3;color:#fff;border:none;border-radius:6px;">Upload Prescription</button>
          <button type="button" id="scanPrescriptionBtn" style="padding:8px 12px;background:#4fd17c;color:#fff;border:none;border-radius:6px;">Scan & Analyze</button>
        </form>
      </div>
      <table class="data-table" id="prescriptionsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>File</th>
            <th>Status</th>
            <th>Notes</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Scan Prescription Tab -->
    <div id="scan" class="tab-content">
      <h2>Scan Prescription (AI Scan)</h2>
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);max-width:720px;">
        <form id="scanForm">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <input type="file" name="scan" accept="image/*,application/pdf" required />
            <input type="text" name="notes" placeholder="Optional notes" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;" />
            <button type="submit" style="padding:8px 12px;background:#4fd17c;color:#fff;border:none;border-radius:6px;">Upload & Scan</button>
          </div>
        </form>

        <div id="aiResult" style="margin-top:12px;display:none;background:#f7f9fb;padding:12px;border-radius:6px;">
          <h3>AI Scan Result</h3>
          <pre id="aiResultJson" style="white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>

    <!-- Ambulance Tab -->
    <div id="ambulance" class="tab-content">
      <h2>Ambulance Requests</h2>
      <table class="data-table" id="ambulanceTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Emergency</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Doctor Tab -->
    <div id="doctor" class="tab-content">
      <h2>Doctor Appointments</h2>
      <table class="data-table" id="doctorTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Issue</th>
            <th>Preferred Time</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Products Tab -->
    <div id="products" class="tab-content">
      <h2>Products</h2>
      <div style="margin-bottom:16px; display:flex; gap:12px; align-items:flex-start;">
        <form id="productForm" style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);">
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <input name="productName" placeholder="Product name" required style="padding:8px;border-radius:6px;border:1px solid #ddd;" />
            <input name="price" type="number" step="0.01" placeholder="Price" required style="padding:8px;border-radius:6px;border:1px solid #ddd;" />
            <input name="category" placeholder="Category (e.g., Pain Relief)" style="padding:8px;border-radius:6px;border:1px solid #ddd;" />
            <input name="size" placeholder="Size (e.g., 10 tablets)" style="padding:8px;border-radius:6px;border:1px solid #ddd;" />
            <input name="discount" placeholder="Discount (optional)" style="padding:8px;border-radius:6px;border:1px solid #ddd;" />
            <input name="productImage" type="file" accept="image/*" style="padding:8px;" />
            <textarea name="description" placeholder="Description" rows="2" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;"></textarea>
          </div>
          <div style="margin-top:8px;text-align:right;">
            <button type="submit" style="padding:8px 12px;background:#4fd17c;color:#fff;border:none;border-radius:6px;">Create Product</button>
          </div>
        </form>
      </div>
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
            <th>Image</th>
            <th>Discount</th>
            <th>Category</th>
            <th>Size</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Payments Tab -->
    <div id="payments" class="tab-content">
      <h2>Payments</h2>
      <table class="data-table" id="paymentsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Order ID</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Check admin session
    (async function(){
      try {
        const res = await fetch('/api/session', { credentials: 'same-origin' });
        if (!res.ok) { window.location.href = '/admin-login.html'; return; }
        const json = await res.json();
        if (!json || !json.ok) { window.location.href = '/admin-login.html'; }
      } catch (err) { window.location.href = '/admin-login.html'; }
    })();

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
      window.location.href = '/admin-login.html';
    });

    function showTab(ev, tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      ev.currentTarget.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    function formatDate(iso) {
      if (!iso) return 'N/A';
      const d = new Date(iso);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    }

    async function loadOrders() {
      try {
        const res = await fetch('/api/orders', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalOrders').textContent = data.orders.length;
        data.orders.forEach(o => {
          const items = JSON.parse(o.items || '[]');
          const status = o.status || 'pending';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${o.id}</td>
            <td>${o.cartId}</td>
            <td>₹${Number(o.total).toFixed(2)}</td>
            <td>${items.length} items</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${formatDate(o.createdAt)}</td>
            <td>
              <select class="order-status-select" data-order-id="${o.id}" style="padding:4px 8px;border-radius:4px;">
                <option value="pending" ${status==='pending'?'selected':''}  >Pending</option>
                <option value="confirmed" ${status==='confirmed'?'selected':''}>Confirmed</option>
                <option value="processing" ${status==='processing'?'selected':''}>Processing</option>
                <option value="shipped" ${status==='shipped'?'selected':''}>Shipped</option>
                <option value="out-for-delivery" ${status==='out-for-delivery'?'selected':''}>Out for Delivery</option>
                <option value="delivered" ${status==='delivered'?'selected':''}>Delivered</option>
              </select>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        // Add event listeners for status change
        document.querySelectorAll('.order-status-select').forEach(select => {
          select.addEventListener('change', async (e) => {
            const orderId = e.target.dataset.orderId;
            const newStatus = e.target.value;
            try {
              const res = await fetch(`/api/orders/${orderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ status: newStatus })
              });
              if (res.ok) {
                alert('Order status updated!');
                loadOrders();
              } else {
                alert('Failed to update status');
              }
            } catch (err) {
              console.error(err);
              alert('Error updating status');
            }
          });
        });
      } catch (err) { console.error(err); }
    }

    async function loadProfiles() {
      try {
        const res = await fetch('/api/profiles', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#profilesTable tbody');
        tbody.innerHTML = '';
        data.profiles.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.email}</td>
            <td>${p.phone || 'N/A'}</td>
            <td>${p.address || 'N/A'}</td>
            <td>${formatDate(p.createdAt)}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function loadPrescriptions() {
      try {
        const res = await fetch('/api/prescriptions', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#prescriptionsTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalPrescriptions').textContent = data.prescriptions.length;
        data.prescriptions.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.id}</td>
            <td><a href="${p.fileUrl}" target="_blank">View File</a></td>
            <td><span class="status-badge status-${p.status}">${p.status}</span></td>
            <td>${p.notes || 'N/A'}</td>
            <td>${formatDate(p.createdAt)}</td>
            <td>
              <button class="action-btn btn-complete" onclick="updatePrescription(${p.id}, 'completed')">Complete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    // Prescription upload (original upload) and scan (AI) handlers placed beside table
    document.getElementById('prescriptionUploadForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const fileInput = form.querySelector('input[name="prescriptionFile"]');
      const notes = form.prescriptionNotes.value || '';
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Select a file to upload'); return; }
      const fd = new FormData();
      fd.append('prescription', fileInput.files[0]);
      fd.append('notes', notes);
      try {
        const res = await fetch('/api/prescriptions', { method: 'POST', body: fd, credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok) {
          alert('Prescription uploaded');
          form.reset();
          loadPrescriptions();
        } else {
          alert(data.error || 'Upload failed');
        }
      } catch (err) { console.error('Upload error', err); alert('Network error during upload'); }
    });

    document.getElementById('scanPrescriptionBtn')?.addEventListener('click', async function(e) {
      const form = document.getElementById('prescriptionUploadForm');
      const fileInput = form.querySelector('input[name="prescriptionFile"]');
      const notes = form.prescriptionNotes.value || '';
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Select a file to scan'); return; }
      const fd = new FormData();
      fd.append('scan', fileInput.files[0]);
      fd.append('notes', notes);
      try {
        const res = await fetch('/api/prescriptions/scan', { method: 'POST', body: fd, credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok) {
          // show AI result
          const ai = data.aiResult || data.prescription?.notes || null;
          if (ai) {
            const aiPanel = document.getElementById('aiResult');
            const aiJson = document.getElementById('aiResultJson');
            aiPanel.style.display = 'block';
            aiJson.textContent = typeof ai === 'string' ? ai : JSON.stringify(ai, null, 2);
          }
          alert('Scan uploaded and processed');
          form.reset();
          loadPrescriptions();
        } else {
          alert(data.error || 'Scan failed');
        }
      } catch (err) { console.error('Scan error', err); alert('Network error during scan'); }
    });

    async function loadAmbulance() {
      try {
        const res = await fetch('/api/ambulance', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#ambulanceTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalAmbulance').textContent = data.requests.length;
        data.requests.forEach(a => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${a.id}</td>
            <td>${a.name}</td>
            <td>${a.phone}</td>
            <td>${a.address}</td>
            <td>${a.emergency}</td>
            <td><span class="status-badge status-${a.status}">${a.status}</span></td>
            <td>${formatDate(a.createdAt)}</td>
            <td>
              <button class="action-btn btn-complete" onclick="updateAmbulance(${a.id}, 'completed')">Complete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function loadDoctor() {
      try {
        const res = await fetch('/api/doctor', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#doctorTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalDoctor').textContent = data.appointments.length;
        data.appointments.forEach(d => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${d.id}</td>
            <td>${d.name}</td>
            <td>${d.phone}</td>
            <td>${d.issue}</td>
            <td>${d.preferredTime}</td>
            <td><span class="status-badge status-${d.status}">${d.status}</span></td>
            <td>${formatDate(d.createdAt)}</td>
            <td>
              <button class="action-btn btn-complete" onclick="updateDoctor(${d.id}, 'completed')">Complete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    // ========== Products ===========
    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        const tbody = document.querySelector('#productsTable tbody');
        tbody.innerHTML = '';
        (data.products || []).forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>₹${Number(p.price).toFixed(2)}</td>
            <td>${p.imageUrl ? `<a href='${p.imageUrl}' target='_blank'>View</a>` : 'N/A'}</td>
            <td>${p.discount || 'N/A'}</td>
            <td>${p.category || 'N/A'}</td>
            <td>${p.size || 'N/A'}</td>
            <td>${formatDate(p.createdAt)}</td>
            <td>
              <button class="action-btn btn-delete" onclick="deleteProduct(${p.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function createProduct(form) {
      try {
        const fileInput = form.querySelector('input[name="productImage"]');
        let imageUrl = null;
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          if (window._FirebaseClient && window._FirebaseClient.uploadImageToStorage) {
            imageUrl = await window._FirebaseClient.uploadImageToStorage(file, 'products');
          } else {
            // fallback to form upload
            const fd = new FormData(form);
            const res = await fetch('/api/products', { method: 'POST', body: fd, credentials: 'same-origin' });
            if (res.ok) { alert('Product created'); form.reset(); loadProducts(); return; }
            else { const json = await res.json(); alert(json.error || 'Failed to create'); return; }
          }
        }

        // Submit metadata to server (imageUrl will be used)
        const payload = {
          productName: form.productName.value,
          price: form.price.value,
          description: form.description.value,
          discount: form.discount.value || null,
          category: form.category.value || null,
          size: form.size.value || null,
          imageUrl
        };
        const res = await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(payload) });
        if (res.ok) { alert('Product created'); form.reset(); loadProducts(); }
        else { const json = await res.json(); alert(json.error || 'Failed to create'); }
      } catch (err) { console.error(err); alert('Error creating product: ' + (err.message||err)); }
    }

    async function deleteProduct(id) {
      if (!confirm('Delete product #' + id + '?')) return;
      try {
        const res = await fetch('/api/products/' + id, { method: 'DELETE', credentials: 'same-origin' });
        if (res.ok) { loadProducts(); alert('Deleted'); }
        else { alert('Delete failed'); }
      } catch (err) { console.error(err); alert('Error'); }
    }

    document.getElementById('productForm').addEventListener('submit', function(e){ e.preventDefault(); createProduct(e.target); });

    // ========== Payments ===========
    async function loadPayments() {
      try {
        const res = await fetch('/api/payments', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#paymentsTable tbody');
        tbody.innerHTML = '';
        (data.payments || []).forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.orderId}</td>
            <td>₹${Number(p.amount).toFixed(2)}</td>
            <td>${p.method}</td>
            <td>${p.status}</td>
            <td>${formatDate(p.createdAt)}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function updatePrescription(id, status) {
      try {
        await fetch(`/api/prescriptions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        loadPrescriptions();
      } catch (err) { console.error(err); }
    }

    async function updateAmbulance(id, status) {
      try {
        await fetch(`/api/ambulance/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        loadAmbulance();
      } catch (err) { console.error(err); }
    }

    async function updateDoctor(id, status) {
      try {
        await fetch(`/api/doctor/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        loadDoctor();
      } catch (err) { console.error(err); }
    }

    // Scan prescription upload handler
    document.getElementById('scanForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const fileInput = form.querySelector('input[name="scan"]');
      const notes = form.notes.value || '';
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) { alert('Select a file'); return; }
      const fd = new FormData();
      fd.append('scan', fileInput.files[0]);
      fd.append('notes', notes);
      try {
        const res = await fetch('/api/prescriptions/scan', { method: 'POST', body: fd, credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok) {
          // Show AI result if present
          const ai = data.aiResult || data.prescription?.notes || null;
          const aiPanel = document.getElementById('aiResult');
          const aiJson = document.getElementById('aiResultJson');
          if (ai) {
            aiPanel.style.display = 'block';
            aiJson.textContent = typeof ai === 'string' ? ai : JSON.stringify(ai, null, 2);
          }
          form.reset();
          loadPrescriptions();
          alert('Scan uploaded and processed');
        } else {
          alert(data.error || 'Scan failed');
        }
      } catch (err) {
        console.error('Scan upload error', err);
        alert('Network error during scan upload');
      }
    });

  // Load all data on page load
  loadOrders();
  loadProfiles();
  loadPrescriptions();
  loadAmbulance();
  loadDoctor();
  loadProducts();
  loadPayments();

    // Auto-refresh every 30 seconds
    setInterval(() => {
      loadOrders();
      loadProfiles();
      loadPrescriptions();
      loadAmbulance();
      loadDoctor();
    }, 30000);
  </script>
</body>
</html>
