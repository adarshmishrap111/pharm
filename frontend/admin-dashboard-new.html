<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - Pharmida</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .dashboard-container { max-width: 1400px; margin: 24px auto; padding: 20px; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; justify-content: center; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
    .tab.active { background: #4fd17c; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .data-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .data-table th { background: #f8f8f8; font-weight: 600; }
    .data-table tr:hover { background: #f9f9f9; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; }
    .status-pending { background: #fff4e6; color: #ff8800; }
    .status-completed { background: #e6ffe6; color: #00aa00; }
    .status-approved { background: #e6ffe6; color: #00aa00; }
    .status-rejected { background: #ffe6e6; color: #ff0000; }
    .status-scanned { background: #e6f2ff; color: #0066cc; }
    .action-btn { padding: 6px 12px; margin: 0 4px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; text-decoration: none; display: inline-block; }
    .btn-complete { background: #4fd17c; color: #fff; }
    .btn-view { background: #2196f3; color: #fff; }
    .btn-delete { background: #ff5c5c; color: #fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .stat-card h3 { margin: 0 0 8px 0; font-size: 2em; }
    .stat-card p { margin: 0; opacity: 0.9; }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div>
        <h1>🎯 Admin Dashboard</h1>
        <p>Complete pharmacy management system</p>
      </div>
      <div>
        <button onclick="window.location='/admin.html'" style="padding:10px 20px;background:#4fd17c;border:none;border-radius:8px;color:#fff;margin-right:10px;">📦 Product Manager</button>
        <button id="logoutBtn" style="padding:10px 20px;background:#ff6b6b;border:none;border-radius:8px;color:#fff;">🚪 Logout</button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card green">
        <h3 id="totalProducts">0</h3>
        <p>📦 Total Products</p>
      </div>
      <div class="stat-card orange">
        <h3 id="totalPrescriptions">0</h3>
        <p>📋 Prescriptions</p>
      </div>
      <div class="stat-card blue">
        <h3 id="totalOrders">0</h3>
        <p>🛒 Total Orders</p>
      </div>
      <div class="stat-card purple">
        <h3 id="totalUsers">0</h3>
        <p>👥 Registered Users</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
      <button class="tab" onclick="showTab('products')">📦 Products</button>
      <button class="tab" onclick="showTab('orders')">🛒 Orders</button>
      <button class="tab" onclick="showTab('prescriptions')">📋 Prescriptions</button>
      <button class="tab" onclick="showTab('profiles')">👥 Users</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div style="background:#f8f9fa;padding:24px;border-radius:12px;margin-bottom:24px;">
        <h2 style="margin:0 0 12px 0;color:#667eea;">🎯 Admin Dashboard Overview</h2>
        <p style="margin:0;color:#666;">Complete control center for managing your pharmacy operations</p>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#4caf50;margin:0 0 12px 0;">📦 Product Management</h3>
          <p>Manage inventory, add new products, update prices</p>
          <button onclick="showTab('products')" class="action-btn btn-view">Manage Products</button>
        </div>
        
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#2196f3;margin:0 0 12px 0;">🛒 Order Processing</h3>
          <p>Track orders, update status, manage deliveries</p>
          <button onclick="showTab('orders')" class="action-btn btn-view">View Orders</button>
        </div>
        
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#ff9800;margin:0 0 12px 0;">📋 Prescriptions</h3>
          <p>Review uploaded prescriptions, approve/reject</p>
          <button onclick="showTab('prescriptions')" class="action-btn btn-view">Review Prescriptions</button>
        </div>
        
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#9c27b0;margin:0 0 12px 0;">👥 User Management</h3>
          <p>View registered users, manage accounts</p>
          <button onclick="showTab('profiles')" class="action-btn btn-view">Manage Users</button>
        </div>
      </div>
      
      <div style="margin-top:24px;background:#e8f5e8;padding:16px;border-radius:8px;">
        <h4 style="margin:0 0 8px 0;color:#4caf50;">🚀 Quick Actions</h4>
        <button onclick="window.location='/admin.html'" class="action-btn btn-complete" style="margin:4px;">Add Product</button>
        <button onclick="window.location='/upload-prescription.html'" class="action-btn btn-view" style="margin:4px;">Upload Prescription</button>
        <button onclick="window.location='/scan-prescription.html'" class="action-btn btn-view" style="margin:4px;">Scan Prescription</button>
      </div>
    </div>

    <!-- Product Manager Tab -->
    <div id="products" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>📦 Product Manager</h2>
        <button onclick="window.location='/admin.html'" class="action-btn btn-complete">➕ Add New Product</button>
      </div>
      
      <div style="background:#f0f7ff;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#2196f3;">📊 Product Statistics</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Total Products: <strong id="productCount">0</strong></span>
          <span>Categories: <strong id="categoryCount">5</strong></span>
          <span>Active: <strong id="activeCount">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th>Image</th>
            <th>Product Name</th>
            <th>Price (₹)</th>
            <th>Description</th>
            <th>Discount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Orders Tab -->
    <div id="orders" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>🛒 Order Management</h2>
        <div>
          <select id="orderStatusFilter" onchange="filterOrders()" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>
      
      <div style="background:#e8f5e8;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#4caf50;">💰 Order Statistics</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Total Orders: <strong id="totalOrdersCount">0</strong></span>
          <span>Today's Revenue: <strong id="todayRevenue">₹0</strong></span>
          <span>Pending Orders: <strong id="pendingOrdersCount">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total (₹)</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Prescriptions Tab -->
    <div id="prescriptions" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>📋 Prescription Management</h2>
        <div>
          <button onclick="window.location='/upload-prescription.html'" class="action-btn btn-view">📤 Upload</button>
          <button onclick="window.location='/scan-prescription.html'" class="action-btn btn-complete">📷 Scan</button>
        </div>
      </div>
      
      <div style="background:#fff5f5;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#f44336;">⚡ Prescription Status Overview</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Pending: <strong id="pendingPrescriptions">0</strong></span>
          <span>Approved: <strong id="approvedPrescriptions">0</strong></span>
          <span>Rejected: <strong id="rejectedPrescriptions">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="prescriptionsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>File</th>
            <th>Status</th>
            <th>Notes</th>
            <th>Upload Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Profiles Tab -->
    <div id="profiles" class="tab-content">
      <h2>👥 User Profiles</h2>
      <div style="background:#f0f7ff;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#2196f3;">👥 User Statistics</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Total Users: <strong id="userCount">0</strong></span>
          <span>Active Today: <strong id="activeToday">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="profilesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Joined</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Loading indicator
    function showLoading(show = true) {
      const loading = document.getElementById('loadingIndicator') || createLoadingIndicator();
      loading.style.display = show ? 'flex' : 'none';
    }

    function createLoadingIndicator() {
      const loading = document.createElement('div');
      loading.id = 'loadingIndicator';
      loading.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;';
      loading.innerHTML = '<div style="text-align:center;"><div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #4fd17c;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div><p>Loading Dashboard...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>';
      document.body.appendChild(loading);
      return loading;
    }

    // Check admin session
    (async function(){
      showLoading(true);
      try {
        console.log('Checking admin session...');
        const res = await fetch('/api/session', { credentials: 'same-origin' });
        console.log('Session response:', res.status, res.statusText);
        
        if (!res.ok) { 
          console.log('Session check failed, redirecting to login');
          if (confirm('Session expired. Would you like to continue without authentication for testing?')) {
            await loadDashboardData();
            showLoading(false);
            return;
          }
          window.location.href = '/admin-login.html'; 
          return; 
        }
        
        const json = await res.json();
        console.log('Session data:', json);
        
        if (!json || !json.ok) { 
          console.log('Session invalid, redirecting to login');
          if (confirm('Session invalid. Would you like to continue without authentication for testing?')) {
            await loadDashboardData();
            showLoading(false);
            return;
          }
          window.location.href = '/admin-login.html'; 
          return;
        }
        
        console.log('Session valid, loading dashboard data');
        await loadDashboardData();
        showLoading(false);
        
      } catch (err) { 
        console.error('Session check error:', err);
        showLoading(false);
        alert(`Error connecting to server: ${err.message}. Please check if backend is running on port 3000.`);
        if (confirm('Server connection failed. Would you like to continue without authentication for testing?')) {
          await loadDashboardData();
          return;
        }
        window.location.href = '/admin-login.html'; 
      }
    })();

    async function loadDashboardData() {
      try {
        await Promise.all([
          loadStatistics(),
          loadProducts(),
          loadOrders(),
          loadPrescriptions(),
          loadUsers()
        ]);
        console.log('Dashboard data loaded successfully');
      } catch (err) {
        console.error('Error loading dashboard data:', err);
        alert('Error loading dashboard data');
      }
    }

    async function loadStatistics() {
      try {
        // Load products count
        const productsRes = await fetch('/api/products');
        const productsData = await productsRes.json();
        document.getElementById('totalProducts').textContent = productsData.products?.length || 0;

        // Load prescriptions count
        try {
          const prescriptionsRes = await fetch('/api/prescriptions', { credentials: 'same-origin' });
          if (prescriptionsRes.ok) {
            const prescriptionsData = await prescriptionsRes.json();
            document.getElementById('totalPrescriptions').textContent = prescriptionsData.prescriptions?.length || 0;
          }
        } catch (e) { document.getElementById('totalPrescriptions').textContent = '0'; }

        // Load orders count
        try {
          const ordersRes = await fetch('/api/orders', { credentials: 'same-origin' });
          if (ordersRes.ok) {
            const ordersData = await ordersRes.json();
            document.getElementById('totalOrders').textContent = ordersData.orders?.length || 0;
          }
        } catch (e) { document.getElementById('totalOrders').textContent = '0'; }

        // Load users count
        document.getElementById('totalUsers').textContent = '0'; // Mock for now

      } catch (err) {
        console.error('Error loading statistics:', err);
      }
    }

    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        const products = data.products || [];
        
        // Update product count
        document.getElementById('productCount').textContent = products.length;
        document.getElementById('activeCount').textContent = products.length;
        
        const tbody = document.getElementById('productsTable').querySelector('tbody');
        tbody.innerHTML = '';
        
        products.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${product.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;" alt="${product.name}"></td>
            <td><strong>${product.name}</strong></td>
            <td>₹${product.price}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${product.description || 'No description'}</td>
            <td>${product.discount || 'None'}</td>
            <td>
              <button onclick="editProduct(${product.id})" class="action-btn btn-view">✏️ Edit</button>
              <button onclick="deleteProduct(${product.id})" class="action-btn btn-delete">🗑️ Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading products:', err);
      }
    }

    async function loadPrescriptions() {
      try {
        const res = await fetch('/api/prescriptions', { credentials: 'same-origin' });
        if (!res.ok) return;
        
        const data = await res.json();
        const prescriptions = data.prescriptions || [];
        
        // Update prescription statistics
        const pending = prescriptions.filter(p => p.status === 'pending').length;
        const approved = prescriptions.filter(p => p.status === 'approved').length;
        const rejected = prescriptions.filter(p => p.status === 'rejected').length;
        
        document.getElementById('pendingPrescriptions').textContent = pending;
        document.getElementById('approvedPrescriptions').textContent = approved;
        document.getElementById('rejectedPrescriptions').textContent = rejected;
        
        const tbody = document.getElementById('prescriptionsTable').querySelector('tbody');
        tbody.innerHTML = '';
        
        prescriptions.forEach(prescription => {
          const row = document.createElement('tr');
          const statusClass = `status-${prescription.status}`;
          const date = new Date(prescription.createdAt).toLocaleDateString();
          
          row.innerHTML = `
            <td>#${prescription.id}</td>
            <td>${prescription.userId || 'Anonymous'}</td>
            <td><a href="${prescription.fileUrl}" target="_blank" class="action-btn btn-view">📄 View</a></td>
            <td><span class="status-badge ${statusClass}">${prescription.status}</span></td>
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;">${prescription.notes || 'No notes'}</td>
            <td>${date}</td>
            <td>
              <select onchange="updatePrescriptionStatus(${prescription.id}, this.value)">
                <option value="pending" ${prescription.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="approved" ${prescription.status === 'approved' ? 'selected' : ''}>Approved</option>
                <option value="rejected" ${prescription.status === 'rejected' ? 'selected' : ''}>Rejected</option>
              </select>
              <button onclick="deletePrescription(${prescription.id})" class="action-btn btn-delete">🗑️</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading prescriptions:', err);
      }
    }

    async function loadOrders() {
      try {
        const res = await fetch('/api/orders', { credentials: 'same-origin' });
        if (!res.ok) {
          document.querySelector('#ordersTable tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">No orders found</td></tr>';
          return;
        }
        
        const data = await res.json();
        const orders = data.orders || [];
        
        // Update order statistics
        document.getElementById('totalOrdersCount').textContent = orders.length;
        document.getElementById('pendingOrdersCount').textContent = orders.filter(o => o.status === 'pending').length;
        
        const tbody = document.getElementById('ordersTable').querySelector('tbody');
        tbody.innerHTML = '';
        
        orders.forEach(order => {
          const row = document.createElement('tr');
          const statusClass = `status-${order.status || 'pending'}`;
          const date = new Date(order.createdAt).toLocaleDateString();
          
          row.innerHTML = `
            <td>#${order.id}</td>
            <td>${order.customerName || order.email || 'Guest'}</td>
            <td>${order.itemCount || 'N/A'} items</td>
            <td>₹${parseFloat(order.total || 0).toFixed(2)}</td>
            <td><span class="status-badge ${statusClass}">${order.status || 'pending'}</span></td>
            <td><span class="status-badge ${order.paymentStatus === 'paid' ? 'status-completed' : 'status-pending'}">${order.paymentStatus || 'pending'}</span></td>
            <td>${date}</td>
            <td>
              <button onclick="viewOrder(${order.id})" class="action-btn btn-view">👁️ View</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading orders:', err);
        document.querySelector('#ordersTable tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#ff6666;">Error loading orders</td></tr>';
      }
    }

    async function loadUsers() {
      document.querySelector('#profilesTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666;">User management coming soon</td></tr>';
    }

    // Action functions
    function editProduct(id) {
      window.location.href = `/admin-edit.html?id=${id}`;
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      try {
        const res = await fetch(`/api/products/${id}`, { 
          method: 'DELETE', 
          credentials: 'same-origin' 
        });
        
        if (res.ok) {
          loadProducts();
          loadStatistics();
        } else {
          alert('Failed to delete product');
        }
      } catch (err) {
        alert('Error deleting product');
      }
    }

    async function updatePrescriptionStatus(id, status) {
      try {
        const res = await fetch(`/api/prescriptions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        
        if (res.ok) {
          loadPrescriptions();
        } else {
          alert('Failed to update status');
        }
      } catch (err) {
        alert('Error updating status');
      }
    }

    async function deletePrescription(id) {
      if (!confirm('Are you sure you want to delete this prescription?')) return;
      
      try {
        const res = await fetch(`/api/prescriptions/${id}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });
        
        if (res.ok) {
          loadPrescriptions();
          loadStatistics();
        } else {
          alert('Failed to delete prescription');
        }
      } catch (err) {
        alert('Error deleting prescription');
      }
    }

    function viewOrder(id) {
      alert(`Order details for #${id} would be shown here`);
    }

    function filterOrders() {
      const filter = document.getElementById('orderStatusFilter').value;
      console.log('Filtering orders by:', filter);
      loadOrders();
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
      window.location.href = '/admin-login.html';
    });

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // Load data for specific tabs when they are opened
      if (tabName === 'products') {
        loadProducts();
      } else if (tabName === 'prescriptions') {
        loadPrescriptions();
      } else if (tabName === 'orders') {
        loadOrders();
      }
    }
  </script>
</body>
</html>