<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - Pharmida</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .dashboard-container { max-width: 1400px; margin: 24px auto; padding: 20px; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; justify-content: center; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
    .tab.active { background: #4fd17c; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .data-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .data-table th { background: #f8f8f8; font-weight: 600; }
    .data-table tr:hover { background: #f9f9f9; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; }
    .status-pending { background: #fff4e6; color: #ff8800; }
    .status-completed { background: #e6ffe6; color: #00aa00; }
    .status-scanned { background: #e6f2ff; color: #0066cc; }
    .action-btn { padding: 6px 12px; margin: 0 4px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
    .btn-complete { background: #4fd17c; color: #fff; }
    .btn-view { background: #2196f3; color: #fff; }
    .btn-delete { background: #ff5c5c; color: #fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .stat-card h3 { margin: 0 0 8px 0; font-size: 2em; }
    .stat-card p { margin: 0; opacity: 0.9; }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div>
        <h1>Admin Dashboard</h1>
        <p>Manage all your data from one place</p>
      </div>
      <div>
        <button onclick="window.location='/admin.html'" style="padding:10px 20px;background:#4fd17c;border:none;border-radius:8px;color:#fff;margin-right:10px;">Product Manager</button>
        <button id="logoutBtn" style="padding:10px 20px;background:#ff6b6b;border:none;border-radius:8px;color:#fff;">Logout</button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card green">
        <h3 id="totalProducts">0</h3>
        <p>Total Products</p>
      </div>
      <div class="stat-card orange">
        <h3 id="totalPrescriptions">0</h3>
        <p>Prescriptions</p>
      </div>
      <div class="stat-card blue">
        <h3 id="totalOrders">0</h3>
        <p>Total Orders</p>
      </div>
      <div class="stat-card purple">
        <h3 id="totalUsers">0</h3>
        <p>Registered Users</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
      <button class="tab" onclick="showTab('products')">üì¶ Product Manager</button>
      <button class="tab" onclick="showTab('orders')">üõí Orders</button>
      <button class="tab" onclick="showTab('prescriptions')">üìã Prescriptions</button>
      <button class="tab" onclick="showTab('profiles')">üë• Users</button>
      <button class="tab" onclick="showTab('ambulance')">üöë Ambulance</button>
      <button class="tab" onclick="showTab('doctor')">üë®‚Äç‚öïÔ∏è Doctor Calls</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div style="background:#f8f9fa;padding:24px;border-radius:12px;margin-bottom:24px;">
        <h2 style="margin:0 0 12px 0;color:#667eea;">üéØ Admin Dashboard Overview</h2>
        <p style="margin:0;color:#666;">Complete control center for managing your pharmacy operations</p>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#4caf50;margin:0 0 12px 0;">üì¶ Product Management</h3>
          <p>Manage inventory, add new products, update prices</p>
          <button onclick="showTab('products')" class="action-btn btn-view">Manage Products</button>
        </div>
        
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#2196f3;margin:0 0 12px 0;">üõí Order Processing</h3>
          <p>Track orders, update status, manage deliveries</p>
          <button onclick="showTab('orders')" class="action-btn btn-view">View Orders</button>
        </div>
        
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#ff9800;margin:0 0 12px 0;">üìã Prescriptions</h3>
          <p>Review uploaded prescriptions, approve/reject</p>
          <button onclick="showTab('prescriptions')" class="action-btn btn-view">Review Prescriptions</button>
        </div>
        
        <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color:#9c27b0;margin:0 0 12px 0;">üë• User Management</h3>
          <p>View registered users, manage accounts</p>
          <button onclick="showTab('profiles')" class="action-btn btn-view">Manage Users</button>
        </div>
      </div>
      
      <div style="margin-top:24px;background:#e8f5e8;padding:16px;border-radius:8px;">
        <h4 style="margin:0 0 8px 0;color:#4caf50;">üöÄ Quick Actions</h4>
        <button onclick="window.location='/admin.html'" class="action-btn btn-complete" style="margin:4px;">Add Product</button>
        <button onclick="window.location='/upload-prescription.html'" class="action-btn btn-view" style="margin:4px;">Upload Prescription</button>
        <button onclick="window.location='/scan-prescription.html'" class="action-btn btn-view" style="margin:4px;">Scan Prescription</button>
      </div>
    </div>

    <!-- Product Manager Tab -->
    <div id="products" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>üì¶ Product Manager</h2>
        <button onclick="window.location='/admin.html'" class="action-btn btn-complete">‚ûï Add New Product</button>
      </div>
      
      <div style="background:#f0f7ff;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#2196f3;">üìä Product Statistics</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Total Products: <strong id="productCount">0</strong></span>
          <span>In Stock: <strong id="inStockCount">0</strong></span>
          <span>Low Stock: <strong id="lowStockCount">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="productsTable">
        <thead>
          <tr>
            <th>Image</th>
            <th>Product Name</th>
            <th>Price (‚Çπ)</th>
            <th>Description</th>
            <th>Discount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Orders Tab -->
    <div id="orders" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>üõí Order Management</h2>
        <div>
          <select id="orderStatusFilter" onchange="filterOrders()" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
      
      <div style="background:#e8f5e8;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#4caf50;">üí∞ Order Statistics</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Total Orders: <strong id="totalOrdersCount">0</strong></span>
          <span>Today's Revenue: <strong id="todayRevenue">‚Çπ0</strong></span>
          <span>Pending Orders: <strong id="pendingOrdersCount">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total (‚Çπ)</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Profiles Tab -->
    <div id="profiles" class="tab-content">
      <h2>User Profiles</h2>
      <table class="data-table" id="profilesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Prescriptions Tab -->
    <div id="prescriptions" class="tab-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>üìã Prescription Management</h2>
        <div>
          <button onclick="window.location='/upload-prescription.html'" class="action-btn btn-view">üì§ Upload</button>
          <button onclick="window.location='/scan-prescription.html'" class="action-btn btn-complete">üì∑ Scan</button>
        </div>
      </div>
      
      <div style="background:#fff5f5;padding:16px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 8px 0;color:#f44336;">‚ö° Prescription Status Overview</h4>
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <span>Pending: <strong id="pendingPrescriptions">0</strong></span>
          <span>Approved: <strong id="approvedPrescriptions">0</strong></span>
          <span>Rejected: <strong id="rejectedPrescriptions">0</strong></span>
        </div>
      </div>
      
      <table class="data-table" id="prescriptionsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>File</th>
            <th>Status</th>
            <th>Notes</th>
            <th>Upload Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Ambulance Tab -->
    <div id="ambulance" class="tab-content">
      <h2>Ambulance Requests</h2>
      <table class="data-table" id="ambulanceTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Emergency</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Doctor Tab -->
    <div id="doctor" class="tab-content">
      <h2>Doctor Appointments</h2>
      <table class="data-table" id="doctorTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Issue</th>
            <th>Preferred Time</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Loading indicator
    function showLoading(show = true) {
      const loading = document.getElementById('loadingIndicator') || createLoadingIndicator();
      loading.style.display = show ? 'flex' : 'none';
    }

    function createLoadingIndicator() {
      const loading = document.createElement('div');
      loading.id = 'loadingIndicator';
      loading.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;';
      loading.innerHTML = '<div style="text-align:center;"><div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #4fd17c;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div><p>Loading Dashboard...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>';
      document.body.appendChild(loading);
      return loading;
    }

    // Check admin session
    (async function(){
      showLoading(true);
      try {
        console.log('Checking admin session...');
        const res = await fetch('/api/session', { credentials: 'same-origin' });
        console.log('Session response:', res.status, res.statusText);
        
        if (!res.ok) { 
          console.log('Session check failed, redirecting to login');
          // Temporary bypass for development (remove in production)
          if (confirm('Session expired. Would you like to continue without authentication for testing?')) {
            await loadDashboardData();
            showLoading(false);
            return;
          }
          window.location.href = '/admin-login.html'; 
          return; 
        }
        
        const json = await res.json();
        console.log('Session data:', json);
        
        if (!json || !json.ok) { 
          console.log('Session invalid, redirecting to login');
          // Temporary bypass for development (remove in production)
          if (confirm('Session invalid. Would you like to continue without authentication for testing?')) {
            await loadDashboardData();
            showLoading(false);
            return;
          }
          window.location.href = '/admin-login.html'; 
          return;
        }
        
        console.log('Session valid, loading dashboard data');
        await loadDashboardData();
        showLoading(false);
        
      } catch (err) { 
        console.error('Session check error:', err);
        showLoading(false);
        alert(`Error connecting to server: ${err.message}. Please check if backend is running on port 3000.`);
        // Temporary bypass for development (remove in production)
        if (confirm('Server connection failed. Would you like to continue without authentication for testing?')) {
          await loadDashboardData();
          return;
        }
        window.location.href = '/admin-login.html'; 
      }
    })();

    async function loadDashboardData() {
      try {
        // Load all dashboard data
        await Promise.all([
          loadStatistics(),
          loadProducts(),
          loadOrders(),
          loadPrescriptions(),
          loadUsers(),
          loadAmbulanceRequests(),
          loadDoctorAppointments()
        ]);
        console.log('Dashboard data loaded successfully');
      } catch (err) {
        console.error('Error loading dashboard data:', err);
        alert('Error loading dashboard data');
      }
    }

    async function loadStatistics() {
      try {
        // Load products count
        const productsRes = await fetch('/api/products');
        const productsData = await productsRes.json();
        document.getElementById('totalProducts').textContent = productsData.products?.length || 0;

        // Load prescriptions count
        try {
          const prescriptionsRes = await fetch('/api/prescriptions', { credentials: 'same-origin' });
          if (prescriptionsRes.ok) {
            const prescriptionsData = await prescriptionsRes.json();
            document.getElementById('totalPrescriptions').textContent = prescriptionsData.prescriptions?.length || 0;
          }
        } catch (e) { document.getElementById('totalPrescriptions').textContent = '0'; }

        // Load orders count
        try {
          const ordersRes = await fetch('/api/orders', { credentials: 'same-origin' });
          if (ordersRes.ok) {
            const ordersData = await ordersRes.json();
            document.getElementById('totalOrders').textContent = ordersData.orders?.length || 0;
          }
        } catch (e) { document.getElementById('totalOrders').textContent = '0'; }

        // Load users count
        try {
          const usersRes = await fetch('/api/users', { credentials: 'same-origin' });
          if (usersRes.ok) {
            const usersData = await usersRes.json();
            document.getElementById('totalUsers').textContent = usersData.users?.length || 0;
          }
        } catch (e) { document.getElementById('totalUsers').textContent = '0'; }

      } catch (err) {
        console.error('Error loading statistics:', err);
      }
    }

    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        const products = data.products || [];
        
        // Update product count
        document.getElementById('productCount').textContent = products.length;
        document.getElementById('inStockCount').textContent = products.length; // All products assumed in stock
        document.getElementById('lowStockCount').textContent = '0'; // Mock data
        
        const tbody = document.getElementById('productsTable').querySelector('tbody');
        tbody.innerHTML = '';
        
        products.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${product.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;" alt="${product.name}"></td>
            <td><strong>${product.name}</strong></td>
            <td>‚Çπ${product.price}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${product.description || 'No description'}</td>
            <td>${product.discount || 'None'}</td>
            <td>
              <button onclick="editProduct(${product.id})" class="action-btn btn-view">‚úèÔ∏è Edit</button>
              <button onclick="deleteProduct(${product.id})" class="action-btn btn-delete">üóëÔ∏è Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading products:', err);
      }
    }

    async function loadPrescriptions() {
      try {
        const res = await fetch('/api/prescriptions', { credentials: 'same-origin' });
        if (!res.ok) return;
        
        const data = await res.json();
        const prescriptions = data.prescriptions || [];
        
        // Update prescription statistics
        const pending = prescriptions.filter(p => p.status === 'pending').length;
        const approved = prescriptions.filter(p => p.status === 'approved').length;
        const rejected = prescriptions.filter(p => p.status === 'rejected').length;
        
        document.getElementById('pendingPrescriptions').textContent = pending;
        document.getElementById('approvedPrescriptions').textContent = approved;
        document.getElementById('rejectedPrescriptions').textContent = rejected;
        
        const tbody = document.getElementById('prescriptionsTable').querySelector('tbody');
        tbody.innerHTML = '';
        
        prescriptions.forEach(prescription => {
          const row = document.createElement('tr');
          const statusClass = `status-${prescription.status}`;
          const date = new Date(prescription.createdAt).toLocaleDateString();
          
          row.innerHTML = `
            <td>#${prescription.id}</td>
            <td>${prescription.userId || 'Anonymous'}</td>
            <td><a href="${prescription.fileUrl}" target="_blank" class="action-btn btn-view">üìÑ View</a></td>
            <td><span class="status-badge ${statusClass}">${prescription.status}</span></td>
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;">${prescription.notes || 'No notes'}</td>
            <td>${date}</td>
            <td>
              <select onchange="updatePrescriptionStatus(${prescription.id}, this.value)">
                <option value="pending" ${prescription.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="approved" ${prescription.status === 'approved' ? 'selected' : ''}>Approved</option>
                <option value="rejected" ${prescription.status === 'rejected' ? 'selected' : ''}>Rejected</option>
              </select>
              <button onclick="deletePrescription(${prescription.id})" class="action-btn btn-delete">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading prescriptions:', err);
      }
    }

    async function loadOrders() {
      try {
        const res = await fetch('/api/orders', { credentials: 'same-origin' });
        if (!res.ok) return;
        
        const data = await res.json();
        const orders = data.orders || [];
        
        // Update order statistics
        document.getElementById('totalOrdersCount').textContent = orders.length;
        document.getElementById('pendingOrdersCount').textContent = orders.filter(o => o.status === 'pending').length;
        
        // Calculate today's revenue
        const today = new Date().toDateString();
        const todayOrders = orders.filter(o => new Date(o.createdAt).toDateString() === today);
        const todayRevenue = todayOrders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);
        document.getElementById('todayRevenue').textContent = `‚Çπ${todayRevenue.toFixed(2)}`;
        
        const tbody = document.getElementById('ordersTable').querySelector('tbody');
        tbody.innerHTML = '';
        
        orders.forEach(order => {
          const row = document.createElement('tr');
          const statusClass = `status-${order.status || 'pending'}`;
          const date = new Date(order.createdAt).toLocaleDateString();
          
          row.innerHTML = `
            <td>#${order.id}</td>
            <td>${order.customerName || order.email || 'Guest'}</td>
            <td>${order.itemCount || 'N/A'} items</td>
            <td>‚Çπ${parseFloat(order.total || 0).toFixed(2)}</td>
            <td><span class="status-badge ${statusClass}">${order.status || 'pending'}</span></td>
            <td><span class="status-badge ${order.paymentStatus === 'paid' ? 'status-completed' : 'status-pending'}">${order.paymentStatus || 'pending'}</span></td>
            <td>${date}</td>
            <td>
              <button onclick="viewOrder(${order.id})" class="action-btn btn-view">üëÅÔ∏è View</button>
              <button onclick="updateOrderStatus(${order.id})" class="action-btn btn-complete">‚úÖ Update</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading orders:', err);
      }
    }

    async function loadUsers() {
      // Mock implementation - replace with actual API call
      const tbody = document.getElementById('profilesTable').querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666;">User data not available</td></tr>';
    }

    async function loadAmbulanceRequests() {
      // Mock implementation - replace with actual API call
      const tbody = document.getElementById('ambulanceTable').querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">No ambulance requests</td></tr>';
    }

    async function loadDoctorAppointments() {
      // Mock implementation - replace with actual API call
      const tbody = document.getElementById('doctorTable').querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">No doctor appointments</td></tr>';
    }

    // Action functions
    function editProduct(id) {
      window.location.href = `/admin-edit.html?id=${id}`;
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      try {
        const res = await fetch(`/api/products/${id}`, { 
          method: 'DELETE', 
          credentials: 'same-origin' 
        });
        
        if (res.ok) {
          loadProducts(); // Refresh products list
          loadStatistics(); // Refresh statistics
        } else {
          alert('Failed to delete product');
        }
      } catch (err) {
        alert('Error deleting product');
      }
    }

    async function updatePrescriptionStatus(id, status) {
      try {
        const res = await fetch(`/api/prescriptions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        
        if (res.ok) {
          loadPrescriptions(); // Refresh prescriptions list
        } else {
          alert('Failed to update status');
        }
      } catch (err) {
        alert('Error updating status');
      }
    }

    async function deletePrescription(id) {
      if (!confirm('Are you sure you want to delete this prescription?')) return;
      
      try {
        const res = await fetch(`/api/prescriptions/${id}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });
        
        if (res.ok) {
          loadPrescriptions(); // Refresh prescriptions list
          loadStatistics(); // Refresh statistics
        } else {
          alert('Failed to delete prescription');
        }
      } catch (err) {
        alert('Error deleting prescription');
      }
    }

    function viewOrder(id) {
      alert(`View order functionality for order #${id} would be implemented here`);
    }

    function updateOrderStatus(id) {
      const newStatus = prompt('Enter new status (pending, processing, completed, cancelled):');
      if (newStatus) {
        // Implementation for updating order status
        alert(`Order #${id} status would be updated to: ${newStatus}`);
      }
    }

    function filterOrders() {
      const filter = document.getElementById('orderStatusFilter').value;
      // Implementation for filtering orders by status
      console.log('Filtering orders by:', filter);
      loadOrders(); // For now, just reload all orders
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
      window.location.href = '/admin-login.html';
    });

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // Load data for specific tabs when they are opened
      if (tabName === 'products') {
        loadProducts();
      } else if (tabName === 'prescriptions') {
        loadPrescriptions();
      } else if (tabName === 'orders') {
        loadOrders();
      }
    }

    function formatDate(iso) {
      if (!iso) return 'N/A';
      const d = new Date(iso);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    }
          function formatDate(iso) {
      if (!iso) return 'N/A';
      const d = new Date(iso);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    }
  </script>
</body>
</html>
        
        // Add event listeners for status change
        document.querySelectorAll('.order-status-select').forEach(select => {
          select.addEventListener('change', async (e) => {
            const orderId = e.target.dataset.orderId;
            const newStatus = e.target.value;
            try {
              const res = await fetch(`/api/orders/${orderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ status: newStatus })
              });
              if (res.ok) {
                alert('Order status updated!');
                loadOrders();
              } else {
                alert('Failed to update status');
              }
            } catch (err) {
              console.error(err);
              alert('Error updating status');
            }
          });
        });
      } catch (err) { console.error(err); }
    }

    async function loadProfiles() {
      try {
        const res = await fetch('/api/profiles', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#profilesTable tbody');
        tbody.innerHTML = '';
        data.profiles.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.email}</td>
            <td>${p.phone || 'N/A'}</td>
            <td>${p.address || 'N/A'}</td>
            <td>${formatDate(p.createdAt)}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function loadPrescriptions() {
      try {
        const res = await fetch('/api/prescriptions', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#prescriptionsTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalPrescriptions').textContent = data.prescriptions.length;
        data.prescriptions.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.id}</td>
            <td><a href="${p.fileUrl}" target="_blank">View File</a></td>
            <td><span class="status-badge status-${p.status}">${p.status}</span></td>
            <td>${p.notes || 'N/A'}</td>
            <td>${formatDate(p.createdAt)}</td>
            <td>
              <button class="action-btn btn-complete" onclick="updatePrescription(${p.id}, 'completed')">Complete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function loadAmbulance() {
      try {
        const res = await fetch('/api/ambulance', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#ambulanceTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalAmbulance').textContent = data.requests.length;
        data.requests.forEach(a => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${a.id}</td>
            <td>${a.name}</td>
            <td>${a.phone}</td>
            <td>${a.address}</td>
            <td>${a.emergency}</td>
            <td><span class="status-badge status-${a.status}">${a.status}</span></td>
            <td>${formatDate(a.createdAt)}</td>
            <td>
              <button class="action-btn btn-complete" onclick="updateAmbulance(${a.id}, 'completed')">Complete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function loadDoctor() {
      try {
        const res = await fetch('/api/doctor', { credentials: 'same-origin' });
        const data = await res.json();
        const tbody = document.querySelector('#doctorTable tbody');
        tbody.innerHTML = '';
        document.getElementById('totalDoctor').textContent = data.appointments.length;
        data.appointments.forEach(d => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${d.id}</td>
            <td>${d.name}</td>
            <td>${d.phone}</td>
            <td>${d.issue}</td>
            <td>${d.preferredTime}</td>
            <td><span class="status-badge status-${d.status}">${d.status}</span></td>
            <td>${formatDate(d.createdAt)}</td>
            <td>
              <button class="action-btn btn-complete" onclick="updateDoctor(${d.id}, 'completed')">Complete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function updatePrescription(id, status) {
      try {
        await fetch(`/api/prescriptions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        loadPrescriptions();
      } catch (err) { console.error(err); }
    }

    async function updateAmbulance(id, status) {
      try {
        await fetch(`/api/ambulance/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        loadAmbulance();
      } catch (err) { console.error(err); }
    }

    async function updateDoctor(id, status) {
      try {
        await fetch(`/api/doctor/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ status })
        });
        loadDoctor();
      } catch (err) { console.error(err); }
    }

    // Load all data on page load
    loadOrders();
    loadProfiles();
    loadPrescriptions();
    loadAmbulance();
    loadDoctor();

    // Auto-refresh every 30 seconds
    setInterval(() => {
      loadOrders();
      loadProfiles();
      loadPrescriptions();
      loadAmbulance();
      loadDoctor();
    }, 30000);
  </script>
</body>
</html>
